# Резервное копирование базы данных

## Описание

Система резервного копирования базы данных позволяет:
- Создавать дампы базы данных
- Автоматически архивировать дампы (tar.gz)
- Просматривать список всех дампов
- Скачивать дампы
- Восстанавливать базу данных из дампа
- Удалять старые дампы

## Доступ

Доступ к функции резервного копирования имеют только администраторы системы.

## Расположение

- **Страница**: Настройки → Резервные копии БД
- **API endpoint**: `/api/database_backups.php`
- **Хранение дампов**: `/storage/backups/`

## Использование

### Создание дампа

1. Перейдите в раздел "Настройки"
2. Откройте вкладку "Резервные копии БД"
3. Нажмите кнопку "Создать дамп"
4. Дождитесь завершения создания дампа

Дамп будет автоматически архивирован в формат `.tar.gz` и сохранен в директории `storage/backups/`.

### Просмотр списка дампов

В таблице отображаются все созданные дампы с информацией:
- Имя файла
- Размер файла
- Дата создания

### Скачивание дампа

Нажмите кнопку "Скачать" (иконка загрузки) рядом с нужным дампом.

### Восстановление базы данных

⚠️ **ВНИМАНИЕ!** Восстановление дампа полностью заменяет текущую базу данных. Все текущие данные будут потеряны!

1. Нажмите кнопку "Восстановить" (иконка обновления) рядом с нужным дампом
2. Подтвердите действие дважды
3. Дождитесь завершения восстановления
4. Страница автоматически перезагрузится после успешного восстановления

### Удаление дампа

1. Нажмите кнопку "Удалить" (иконка корзины) рядом с нужным дампом
2. Подтвердите удаление

## Технические детали

### Формат файлов

- Имя файла: `backup_{db_name}_{timestamp}.tar.gz`
- Формат архива: tar.gz
- Внутри архива: SQL файл с дампом базы данных

### Работа в Docker

При работе в Docker окружении:
- `mysqldump` выполняется в контейнере `fisherp_db`
- Файлы сохраняются в контейнере `fisherp_web`
- Директория `storage/backups` монтируется как volume

### Безопасность

- Доступ только для администраторов
- Проверка путей к файлам для предотвращения path traversal
- Логирование всех операций (создание, восстановление, удаление)

## API

### Создание дампа

```http
POST /api/database_backups.php?action=create
```

**Ответ:**
```json
{
  "success": true,
  "message": "Дамп базы данных успешно создан",
  "data": {
    "filename": "backup_u3154158_fisherp_2025-01-06_12-30-45.tar.gz",
    "size": 1048576,
    "size_formatted": "1.00 MB",
    "created_at": 1704544245,
    "created_at_formatted": "06.01.2025 12:30:45"
  }
}
```

### Список дампов

```http
GET /api/database_backups.php?action=list
```

**Ответ:**
```json
{
  "success": true,
  "data": [
    {
      "filename": "backup_u3154158_fisherp_2025-01-06_12-30-45.tar.gz",
      "size": 1048576,
      "size_formatted": "1.00 MB",
      "created_at": 1704544245,
      "created_at_formatted": "06.01.2025 12:30:45"
    }
  ]
}
```

### Скачивание дампа

```http
GET /api/database_backups.php?action=download&filename=backup_...
```

### Восстановление дампа

```http
POST /api/database_backups.php?action=restore
Content-Type: application/x-www-form-urlencoded

filename=backup_...
```

### Удаление дампа

```http
POST /api/database_backups.php?action=delete
Content-Type: application/x-www-form-urlencoded

filename=backup_...
```

## Рекомендации

1. **Регулярное создание дампов**: Рекомендуется создавать дампы перед важными операциями или изменениями
2. **Хранение дампов**: Сохраняйте важные дампы вне сервера для дополнительной безопасности
3. **Очистка старых дампов**: Регулярно удаляйте старые дампы для освобождения места
4. **Проверка дампов**: Периодически проверяйте, что дампы создаются корректно и имеют ненулевой размер

